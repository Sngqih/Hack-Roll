<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talking Objects - AI Personality App</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üó£Ô∏è</text></svg>">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="zoom-container">
        <!-- Top bar (like Zoom header) -->
        <div class="zoom-topbar">
            <div class="zoom-title">
                <h2>üó£Ô∏è Talking Objects</h2>
                <div id="loadingStatus" class="status-indicator">Loading AI model...</div>
            </div>
            <div class="zoom-controls-top">
                <button class="zoom-icon-btn" id="minimizeBtn" title="Minimize">‚àí</button>
                <button class="zoom-icon-btn" id="maximizeBtn" title="Maximize">‚ñ°</button>
                <button class="zoom-icon-btn" id="closeBtn" title="Close">√ó</button>
            </div>
        </div>

        <!-- Main video area -->
        <div class="zoom-main">
            <!-- Chat log sidebar (left side) -->
            <div class="chat-sidebar">
                <div class="sidebar-header">
                    <h3>üí¨ Chat</h3>
                </div>
                <div id="chatLog" class="chat-log"></div>
                <div class="chat-input-container">
                    <input type="text" id="chatInput" class="chat-input" placeholder="Type a message to the objects..." maxlength="200">
                    <button id="chatSendBtn" class="chat-send-btn" title="Send message">‚û§</button>
                </div>
            </div>

            <div class="video-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas"></canvas>
                <canvas id="overlay"></canvas>
                <div class="video-label">Camera Feed</div>
            </div>

            <!-- Participants sidebar (right side) -->
            <div class="zoom-sidebar">
                <div class="sidebar-header">
                    <h3>Participants</h3>
                    <span id="participantCount" class="count-badge">0</span>
                </div>
                <div id="objectsDisplay" class="participants-list"></div>
            </div>
        </div>

        <!-- Bottom control bar (Zoom-style) -->
        <div class="zoom-controlbar">
            <div class="controlbar-left">
                <!-- Left side empty or can add other controls here -->
            </div>

            <div class="controlbar-center">
                <button class="zoom-control-btn mic-btn" id="muteBtn">
                    <span class="icon">üé§</span>
                    <span>Mute</span>
                </button>
                <button class="zoom-control-btn video-btn" id="videoToggleBtn">
                    <span class="icon">üìπ</span>
                    <span>Start Video</span>
                </button>
                <button class="zoom-control-btn settings-btn" id="settingsBtn">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </button>
            </div>

            <div class="controlbar-right">
                <button class="zoom-control-btn objdex-btn" id="objdexBtn">
                    <span class="icon">üìñ</span>
                    <span>ObjDex</span>
                </button>
                <button class="zoom-control-btn end-btn" id="endCallBtn">
                    <span>End Call</span>
                </button>
            </div>
        </div>

        <!-- Settings panel (hidden by default) -->
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-header">
                <h3>Settings</h3>
                <button class="close-settings" id="closeSettingsBtn">√ó</button>
            </div>
            <div class="settings-content">
                <div class="setting-item">
                    <label>
                        <input type="checkbox" id="autoTalk" checked>
                        Auto-talk mode
                    </label>
                </div>
                <div class="setting-item">
                    <h4>Intelligent AI Status</h4>
                    <div id="intelliDisplay" class="intelli-display">
                        <span class="intelli-status" id="intelliStatus">üîÑ Checking...</span>
                        <span class="intelli-details" id="intelliDetails">Initializing LLM system</span>
                    </div>
                </div>
                <div class="setting-item">
                    <label>
                        Detection Threshold: 
                        <input type="range" id="threshold" min="10" max="100" value="50">
                        <span id="threshValue">50%</span>
                    </label>
                </div>
                <div class="setting-item">
                    <h4>Object Filters</h4>
                    <div class="filter-actions">
                        <button id="selectAllObjects" class="pill-btn" type="button">Select all</button>
                        <button id="clearAllObjects" class="pill-btn ghost" type="button">Clear</button>
                    </div>
                    <div id="objectFilters" class="filter-list"></div>
                    <p class="hint">Only checked object types will appear and speak.</p>
                </div>
            </div>
        </div>

        <!-- ObjDex panel (hidden by default) -->
        <div class="objdex-panel" id="objdexPanel">
            <div class="objdex-header">
                <h3>üî¥ ObjDex üîµ</h3>
                <button class="close-objdex" id="closeObjdexBtn">√ó</button>
            </div>
            <div class="objdex-content">
                <div class="objdex-stats">
                    <div class="stat-item">
                        <span class="stat-label">Objects Saved:</span>
                        <span class="stat-value" id="captureCount">0</span>
                    </div>
                </div>
                <div id="objdexList" class="objdex-list"></div>
                <div class="objdex-actions">
                    <button id="downloadObjdexBtn" class="pill-btn">üì• Download Objects</button>
                    <button id="uploadObjdexBtn" class="pill-btn">üì§ Upload Objects</button>
                    <input type="file" id="objdexFile" accept=".zip" style="display:none;">
                </div>
            </div>
        </div>
    </div>

    <!-- TensorFlow.js - Load sequentially to ensure proper order -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // Load TensorFlow.js first
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = () => reject(new Error(`Failed to load script: ${src}`));
                document.body.appendChild(script);
            });
        }
        
        // Load scripts in order
        async function initScripts() {
            const statusEl = document.getElementById('loadingStatus');
            try {
                if (statusEl) statusEl.textContent = 'Loading TensorFlow.js...';
                await loadScript('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.20.0');
                
                // Verify TensorFlow loaded
                if (typeof tf === 'undefined') {
                    throw new Error('TensorFlow.js did not load correctly');
                }
                
                if (statusEl) statusEl.textContent = 'Loading COCO-SSD model library...';
                await loadScript('https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2');
                
                // Verify COCO-SSD loaded
                if (typeof cocoSsd === 'undefined') {
                    throw new Error('COCO-SSD did not load correctly');
                }
                
                if (statusEl) statusEl.textContent = 'Loading Transformers.js for local LLM...';
                await loadScript('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0');
                
                // Verify Transformers.js loaded
                if (typeof window.pipeline === 'undefined') {
                    throw new Error('Transformers.js did not load correctly');
                }
                
                if (statusEl) statusEl.textContent = 'Libraries loaded. Initializing app...';
                // Load app.js after libraries are ready
                await loadScript('app.js');
            } catch (error) {
                console.error('Script loading error:', error);
                if (statusEl) {
                    statusEl.textContent = '‚úó Failed to load libraries. Check console.';
                    statusEl.style.color = '#ef4444';
                }
                alert('Failed to load required libraries:\n' + error.message + '\n\nPlease check your internet connection and refresh.');
            }
        }
        
        // Start loading when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initScripts);
        } else {
            initScripts();
        }
    </script>
</body>
</html>
